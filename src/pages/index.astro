---
import BaseLayout from '../layouts/BaseLayout.astro';
import GalleryModals from '../components/GalleryModals.astro';
import groundsMapScriptUrl from '../scripts/groundsMap.client.js?url';
import partnerSpotlightScriptUrl from '../scripts/partnerSpotlight.client.js?url';
import scheduleCarouselScriptUrl from '../scripts/scheduleCarousel.client.js?url';
import galleryRevealScriptUrl from '../scripts/galleryReveal.client.js?url';
import pageViewCounterScriptUrl from '../scripts/pageViewCounter.js?url';
import runtimeEventsScriptUrl from '../scripts/runtimeEvents.client.js?url';
import eventModalScriptUrl from '../scripts/eventModal.client.js?url';
import { fetchFestivalContent } from '../lib/webeFriendsClient';

const festival = await fetchFestivalContent();
const hero = festival.hero;
const gallery = festival.gallery;
const sponsors = festival.sponsors;
const faqs = festival.faqs;

const pageTitle = hero?.title ?? festival.meta.siteName ?? 'WeBeFriends Integration';
const pageDescription = hero?.description ?? `Latest content powered by WeBeFriends for ${festival.meta.siteName ?? 'this site'}.`;
const ogImage = hero?.background?.src ?? '/images/moon-bkg.png';

const hasHero = Boolean(hero);
const hasGallery = gallery.length > 0;
const hasSponsors = sponsors.length > 0;
const hasFaqs = faqs.length > 0;
const showHighlightsSection = true;
const showScheduleSection = true;
const hasMapsKey = Boolean(import.meta.env.PUBLIC_GOOGLE_MAPS_KEY);
const mapQueryRaw = (import.meta.env.PUBLIC_GOOGLE_MAPS_QUERY ?? 'Yuma Territorial Prison State Historic Park, Yuma AZ').trim();
const mapZoomParsed = Number.parseInt(import.meta.env.PUBLIC_GOOGLE_MAPS_ZOOM ?? '', 10);
const mapZoom = Number.isFinite(mapZoomParsed) ? mapZoomParsed : 15;
const mapId = (import.meta.env.PUBLIC_GOOGLE_MAPS_MAP_ID ?? '').trim();
const mapPreferCloud =
	!import.meta.env.DEV && (import.meta.env.PUBLIC_GOOGLE_MAPS_USE_MAP_ID ?? '').trim().toLowerCase() === 'true';
const mapLocationLabel = pageTitle;
const mapCoverImage = '/images/howlin-map-cover.png';
const mapToggleLabel = hasMapsKey ? 'Click to view the map' : 'Add your map key to enable the map';

const festivalTimeZone = import.meta.env.PUBLIC_FESTIVAL_TIMEZONE ?? 'America/Phoenix';
const nextHowlingHeading = 'Next Howling';

---

<BaseLayout
	title={pageTitle}
	description={pageDescription}
	ogImage={ogImage}
>
	{hasHero && hero && (
		<section
			id="hero"
			class="relative isolate overflow-hidden bg-slate-900/60"
			style={hero.background?.src
				? `background-image: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.85)), url(${hero.background.src}); background-size: cover; background-position: center;`
				: undefined}
		>
			<div class="absolute inset-0 bg-slate-950/50 backdrop-blur-sm"></div>
			<img
				src="/images/sky-moon.png"
				alt="Moonlit clouds"
				width="1080"
				height="919"
				loading="eager"
				decoding="async"
				fetchpriority="high"
				class="pointer-events-none absolute left-1/2 -top-28 block w-[160vw] -translate-x-1/2 max-w-none opacity-60 sm:left-auto sm:-right-16 sm:-top-10 sm:w-[115vw] sm:translate-x-0 sm:opacity-75 lg:-right-24 lg:-top-20 lg:w-[120vw]"
			/>
			<div class="relative mx-auto flex w-full max-w-6xl flex-col gap-12 px-6 py-24 lg:flex-row lg:items-center lg:py-32">
				<div class="flex-1 space-y-6">
					{hero.kicker && hero.kicker.toLowerCase() !== 'venue' && (
						<p class="text-xs font-semibold uppercase tracking-[0.5em] text-fuchsia-300/90">
							{hero.kicker}
						</p>
					)}
					<h1 class="text-4xl font-bold tracking-tight text-white sm:text-5xl lg:text-6xl">
						{hero.title}
					</h1>
					{hero.tagline && <p class="text-xl font-light text-slate-200 sm:text-2xl">{hero.tagline}</p>}
					{hero.description && <p class="max-w-xl text-base text-slate-300 sm:text-lg">{hero.description}</p>}
					<div class="group relative overflow-hidden rounded-3xl border border-fuchsia-500/40 bg-slate-950/45 p-6 shadow-[0_0_35px_-18px_rgba(217,70,239,0.65)] backdrop-blur" data-partner-card data-partner-placement="hero">
						<div class="absolute inset-0 bg-gradient-to-br from-fuchsia-500/5 via-transparent to-emerald-400/10 opacity-0 transition-opacity duration-500 group-hover:opacity-100 pointer-events-none"></div>
						<button
							type="button"
							class="partner-dismiss-button"
							data-partner-dismiss
							aria-label="Dismiss partner spotlight"
						>
							<span aria-hidden="true" class="partner-dismiss-label">X</span>
						</button>
						<div class="relative flex flex-col gap-5 sm:flex-row sm:items-center">
							<div class="flex items-center justify-center">
								<img
									src="/images/rtfyv.jpg"
									alt="Right Turn for Yuma Veterans logo"
									width="120"
									height="120"
									loading="lazy"
									class="h-24 w-24 rounded-full border border-fuchsia-400/60 bg-slate-900 object-cover shadow-[0_0_25px_-12px_rgba(217,70,239,0.65)]"
								/>
							</div>
							<div class="flex-1 space-y-3 text-slate-200">
								<p class="text-xs font-semibold uppercase tracking-[0.45em] text-fuchsia-300/90">Community Partner Spotlight</p>
								<h2 class="text-2xl font-semibold text-white sm:text-3xl">Right Turn for Yuma Veterans</h2>
								<p class="text-sm text-slate-300">
									Supporting Our Veterans &amp; Community ‚Äî we're proud to partner with Right Turn for Yuma Veterans at every Howling at the Moon festival.
								</p>
							</div>
						</div>
						<div class="relative mt-5 space-y-3 text-sm text-slate-300 partner-card__body">
							<p data-partner-footer-teaser hidden class="partner-card__footer-teaser text-sm text-slate-300">
								They rally fundraising, volunteer crews, and hands-on care for every Howling night‚Äîopen up for the full story.
							</p>
							<p data-partner-summary>
								Supporting our veterans &amp; community, Right Turn for Yuma Veterans brings mission-driven fundraising and on-the-ground support to every Howling at the Moon.
							</p>
							<div data-partner-details hidden class="space-y-3 partner-card__details">
								<p>
									This local charity is dedicated to uplifting veterans through hands-on support. They‚Äôll join us at each fest with fundraising fun like 50/50 drawings and interactive activities‚Äîevery dollar raised goes directly to their mission.
								</p>
								<p>
									In return, their incredible crew helps us with setup and teardown so the grounds stay welcoming for every Howler. We‚Äôre grateful for their service and the chance to give back alongside you.
								</p>
								<p class="text-xs uppercase tracking-[0.35em] text-emerald-300/80">Thank you for helping us make a difference.</p>
							</div>
							<button
								type="button"
								class="inline-flex items-center gap-2 rounded-full border border-transparent px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200 transition hover:border-emerald-300/60 hover:text-white"
								data-partner-toggle
								aria-expanded="false"
							>
								Read more
							</button>
						</div>
						<div class="relative mt-6 flex flex-wrap gap-3">
							<button
								type="button"
								class="inline-flex items-center gap-2 rounded-full border border-emerald-400/70 bg-emerald-500/15 px-6 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-100 transition hover:border-fuchsia-400 hover:text-white"
								data-open-modal="modal-camping-info"
							>
								Camping Info
							</button>
						</div>
					</div>
				</div>
				<div class="relative w-full flex-1 overflow-hidden rounded-3xl border border-slate-800/70 bg-slate-950/40 shadow-[0_0_35px_-10px_rgba(217,70,239,0.35)] mt-8 lg:mt-0 lg:max-w-xl">
					<video
						src="/videos/howl-crowd.mp4"
						autoplay
						loop
						muted
						playsinline
						preload="metadata"
						poster={hero.background?.src}
						class="aspect-video h-full w-full object-cover"
						aria-label="Crowd highlight reel from Howlin at the Moon"
					></video>
					<div class="pointer-events-none absolute inset-0 bg-gradient-to-tr from-slate-950/60 via-transparent to-fuchsia-500/10"></div>
				</div>
			</div>
		</section>
		<script type="module" src={partnerSpotlightScriptUrl}></script>
	)}

	{showHighlightsSection && (
		<section id="highlights" class="border-y border-slate-800 bg-slate-950/80">
			<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-6 py-16">
				<div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
					<div>
						<h2 class="mt-2 text-3xl font-semibold text-white sm:text-4xl" data-next-howling-heading>
							{nextHowlingHeading}
						</h2>
					</div>
				</div>
				<div class="grid gap-6 sm:grid-cols-2 sm:justify-items-center" data-event-highlights>
					<div class="w-full max-w-md rounded-3xl border border-dashed border-slate-800 bg-slate-900/50 p-6 text-center text-sm text-slate-400">
						Fetching upcoming sets‚Ä¶
					</div>
				</div>
			</div>
		</section>
	)}

	<section id="grounds-map" class="border-t border-slate-800 bg-slate-950/85">
		<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-6 py-20">
			<header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
				<div>
					<h2 class="text-3xl font-semibold text-white sm:text-4xl">Festival Grounds Map</h2>
				</div>
			</header>
			<div
				data-map-container
				class={`relative overflow-hidden rounded-3xl border ${
					hasMapsKey ? 'border-slate-800 bg-slate-900/60' : 'border-dashed border-slate-700 bg-slate-900/40'
				}`}
				data-map-key={hasMapsKey ? import.meta.env.PUBLIC_GOOGLE_MAPS_KEY : ''}
				data-map-query={mapQueryRaw}
				data-map-zoom={String(mapZoom)}
				data-map-map-id={mapId}
				data-map-use-cloud={mapPreferCloud && mapId ? 'true' : 'false'}
				data-map-label={mapLocationLabel}
			>
				<div data-map-canvas class="hidden h-[420px] w-full"></div>
				<div class="pointer-events-none absolute inset-0 hidden items-center justify-center bg-slate-950/85 text-sm font-semibold uppercase tracking-[0.35em] text-fuchsia-100" data-map-loading>
					Loading map‚Ä¶
				</div>
				<div class="pointer-events-none absolute inset-0 hidden items-center justify-center bg-rose-900/80 text-center text-sm font-semibold text-rose-100" data-map-error>
					We couldn‚Äôt load the live map. Please check your Google Maps configuration.
				</div>
				<button
					type="button"
					data-map-toggle
					class={`group relative flex h-[420px] w-full items-center justify-center overflow-hidden text-white transition ${
						hasMapsKey ? 'border border-slate-800 hover:border-fuchsia-400/70 hover:shadow-[0_0_35px_-10px_rgba(217,70,239,0.45)]' : 'border border-dashed border-slate-700'
					}`}
					style="cursor: pointer;"
					disabled={!hasMapsKey}
				>
					<img
						src={mapCoverImage}
						alt="Stylized festival map teaser graphic"
						class="absolute inset-0 h-full w-full object-cover opacity-80 transition duration-500 group-hover:scale-105 group-hover:opacity-100"
					/>
					<div class="absolute inset-0 bg-gradient-to-br from-slate-950/85 via-slate-900/70 to-fuchsia-500/20"></div>
					<span class="relative z-10 text-center text-lg font-semibold uppercase tracking-[0.4em] text-fuchsia-100">
						{mapToggleLabel}
					</span>
				</button>
			</div>
			{!hasMapsKey && (
				<p class="text-sm text-slate-400">
					Add a Google Maps API key to the <code class="rounded bg-slate-900 px-2 py-1 text-xs text-slate-200">PUBLIC_GOOGLE_MAPS_KEY</code> variable in your <code class="rounded bg-slate-900 px-2 py-1 text-xs text-slate-200">.env.local</code> file to unlock the live map. Provide a custom location or coordinates with <code class="rounded bg-slate-900 px-2 py-1 text-xs text-slate-200">PUBLIC_GOOGLE_MAPS_QUERY</code> and an optional zoom via <code class="rounded bg-slate-900 px-2 py-1 text-xs text-slate-200">PUBLIC_GOOGLE_MAPS_ZOOM</code>.
				</p>
			)}
		</div>
		<script type="module" src={groundsMapScriptUrl}></script>
	</section>

	{showScheduleSection && (
		<section id="schedule" class="bg-slate-950/90">
		<div class="mx-auto flex w-full max-w-6xl flex-col gap-10 px-6 py-20">
			<header class="flex flex-col gap-4">
				<p class="text-xs font-semibold uppercase tracking-[0.4em] text-emerald-300/80">See Our Events</p>
				<h2 class="text-3xl font-semibold text-white sm:text-4xl">Full Season Schedule</h2>
				<p class="max-w-3xl text-sm text-slate-300 sm:text-base">
					Remember Howlers ‚Äî due to the unpredictable weather here in the foothills, all events are subject to change without notice. It's always best to check before heading out!
				</p>
			</header>
			<div class="relative">
				<div
					class="flex snap-x snap-mandatory gap-6 overflow-x-auto pb-4 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden lg:grid lg:grid-cols-2 lg:overflow-visible lg:pb-0 lg:snap-none"
					data-schedule-carousel
					data-event-schedule
				>
					<div class="min-w-[85vw] rounded-3xl border border-dashed border-slate-800 bg-slate-950/40 p-6 text-sm text-slate-400 lg:min-w-0">
						Building the new lineup‚Ä¶
					</div>
				</div>
				<div class="mt-4 flex justify-center lg:hidden">
					<button
						type="button"
						class="hidden items-center justify-center rounded-full border border-slate-700 bg-slate-900/70 px-6 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-slate-100 transition hover:border-fuchsia-400 hover:text-white"
						data-schedule-show-more
						aria-hidden="true"
					>
						See more
					</button>
				</div>
			</div>
			<script type="module" src={scheduleCarouselScriptUrl}></script>
		</div>
		</section>
	)}

	{hasGallery && (
		<section id="gallery" class="border-t border-slate-800 bg-slate-950/80">
		<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-6 py-20">
			<header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
				<div>
					<p class="text-xs font-semibold uppercase tracking-[0.4em] text-fuchsia-300/80">Memories</p>
					<h2 class="text-3xl font-semibold text-white sm:text-4xl">Festival Glimpses</h2>
				</div>
				<p class="max-w-xl text-sm text-slate-300">
					Some of the amazing times we have had out here, captured on film.
				</p>
			</header>
			<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4" data-gallery-grid>
				{gallery.map((image, index) => {
					const galleryKey = `gallery-${index}`;
					const modalId = `modal-gallery-${index}`;
					const caption = image.alt || `Festival photo ${index + 1}`;
					const isMobileHidden = index >= 3;
					return (
						<button
							key={image.src}
							type="button"
							class={`group relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/50 text-left transition hover:border-fuchsia-400/70 focus:outline-none focus:ring-2 focus:ring-fuchsia-400/60 ${isMobileHidden ? 'hidden sm:block' : ''}`}
							data-gallery-toggle
							data-gallery-target={modalId}
							data-gallery-id={galleryKey}
							data-gallery-item
							data-gallery-mobile-hidden={isMobileHidden ? 'true' : 'false'}
						>
							<span
								class="absolute left-3 top-3 z-10 flex items-center gap-1 rounded-full bg-slate-950/80 px-3 py-1 text-xs font-semibold text-slate-200"
								data-gallery-badge-wrapper={galleryKey}
								aria-live="polite"
							>
								<span aria-hidden="true">üí¨</span>
								<span data-gallery-badge={galleryKey}>0</span>
								<span class="sr-only" data-gallery-badge-sr>0 comments on this photo</span>
							</span>
							<img
								src={image.src}
								alt={image.alt}
								class="h-52 w-full object-cover transition duration-500 group-hover:scale-105"
							/>
							<span class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-950/80 via-slate-950/50 to-transparent px-4 py-3 text-xs uppercase tracking-[0.3em] text-slate-200">
								{caption}
							</span>
							<span class="sr-only">Open full view of {caption}</span>
						</button>
					);
				})}
			</div>
				{gallery.length > 3 && (
					<div class="mt-6 flex justify-center sm:hidden">
						<button
							type="button"
							class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/70 px-6 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-slate-100 transition hover:border-fuchsia-400 hover:text-white"
							data-gallery-show-more
						>
							See more memories
						</button>
					</div>
				)}
				<script type="module" src={galleryRevealScriptUrl}></script>
		</div>
		</section>
	)}

	{hasSponsors && (
		<section id="sponsors" class="bg-slate-900/70">
		<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-6 py-20">
			<header class="flex flex-col gap-3">
				<p class="text-xs font-semibold uppercase tracking-[0.4em] text-emerald-300/80">Partners</p>
				<h2 class="text-3xl font-semibold text-white sm:text-4xl">Powered by the Pack</h2>
				<p class="max-w-2xl text-sm text-slate-300">
					Community sponsors and production partners make the festival glow. Shout-outs update automatically when WeBeFriends publishes new data.
				</p>
			</header>
			<div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
				{sponsors.map((sponsor) => (
					<article key={sponsor.name} class="flex flex-col gap-3 rounded-3xl border border-slate-800 bg-slate-950/70 p-6">
						<p class="text-xs font-semibold uppercase tracking-[0.4em] text-fuchsia-300/80">{sponsor.tier}</p>
						<h3 class="text-lg font-semibold text-white">{sponsor.name}</h3>
						<p class="text-sm text-slate-300">{sponsor.description}</p>
					</article>
				))}
			</div>
		</div>
		</section>
	)}

	{hasFaqs && (
		<section id="faq" class="border-t border-slate-800 bg-slate-950/90">
		<div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-6 py-20">
			<header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
				<div>
					<p class="text-xs font-semibold uppercase tracking-[0.4em] text-fuchsia-300/80">Know Before You Go</p>
					<h2 class="text-3xl font-semibold text-white sm:text-4xl">FAQs</h2>
				</div>
				<p class="max-w-xl text-sm text-slate-300">
					Operated directly from the WeBeFriends FAQ bundle, so your attendees always see the latest guidance.
				</p>
			</header>
			<div class="grid gap-6 md:grid-cols-2">
				{faqs.map((faq) => (
					<article key={faq.question} class="flex flex-col gap-3 rounded-3xl border border-slate-800 bg-slate-900/60 p-6">
						<h3 class="text-lg font-semibold text-white">{faq.question}</h3>
						<p class="text-sm text-slate-300">{faq.answer}</p>
					</article>
				))}
			</div>
		</div>
		</section>
	)}

	{hasGallery && <GalleryModals images={gallery} />}

	<div data-event-modals-root></div>
	<dialog
		id="modal-camping-info"
		data-event-modal="true"
		class="backdrop:bg-slate-950/80 w-full max-w-3xl rounded-3xl border border-slate-700/60 bg-slate-900/95 p-0 text-slate-100 shadow-2xl"
		aria-labelledby="modal-title-camping"
	>
		<div class="flex flex-col gap-6 p-8">
			<div class="flex items-start justify-between gap-4">
				<div>
					<p class="text-xs font-semibold uppercase tracking-[0.3em] text-fuchsia-300/80">Overnight Stay</p>
					<h3 id="modal-title-camping" class="mt-2 text-3xl font-bold text-white">
						üèïÔ∏è Howling at the Moon Fest ‚Äî Camping Rules &amp; Agreement
					</h3>
				</div>
				<button
					type="button"
					class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-700/70 bg-slate-800/60 text-slate-300 transition hover:border-slate-500 hover:text-white"
					data-close-modal="modal-camping-info"
				>
					<span class="sr-only">Close modal</span>
					&times;
				</button>
			</div>
			<div class="grid gap-3 rounded-2xl border border-slate-700/60 bg-slate-900/60 p-6 text-sm text-slate-200">
				<p><span class="font-semibold text-white">Camping Rate:</span> $25.00 per day</p>
				<p><span class="font-semibold text-white">Payment:</span> Must be paid in full up front before setting up camp.</p>
				<p><span class="font-semibold text-white">Event Duration:</span> 2 days</p>
				<p><span class="font-semibold text-white">Check-Out Time:</span> 12:00 PM (noon) the day after the second day of the event.</p>
			</div>
			<div class="space-y-4 text-sm text-slate-200">
				<h4 class="text-lg font-semibold text-white">Campground Rules</h4>
				<ol class="space-y-3 list-decimal pl-5">
					<li>
						<p class="font-semibold text-white">Park at Your Own Risk</p>
						<p class="mt-1 text-slate-300">The camping area is extremely rocky, with many large and sometimes sharp rocks.</p>
						<p class="text-slate-300">Although we work hard to find and remove as many rocks as possible, plenty remain in the ground.</p>
						<p class="text-slate-300">The festival and venue are not responsible for any flat tires, punctures, or vehicle damage caused by terrain conditions.</p>
					</li>
					<li>
						<p class="font-semibold text-white">Noise Policy</p>
						<p class="mt-1 text-slate-300">No loud music is permitted during the festival‚Äôs live music performances.</p>
						<p class="text-slate-300">Quiet hours begin at 10:00 PM each night. Please respect other campers and nearby residents.</p>
					</li>
					<li>
						<p class="font-semibold text-white">Cooking and Campfires</p>
						<p class="mt-1 text-slate-300">Cooking is only allowed at your campsite.</p>
						<p class="text-slate-300">No cooking or open flames are permitted inside the main event seating area.</p>
						<p class="text-slate-300">Please use safe cooking practices and keep fire safety equipment nearby.</p>
					</li>
					<li>
						<p class="font-semibold text-white">Cleanup</p>
						<p class="mt-1 text-slate-300">Leave your campsite as you found it. Dispose of all trash properly.</p>
					</li>
					<li>
						<p class="font-semibold text-white">Responsibility</p>
						<p class="mt-1 text-slate-300">The festival and property owners are not liable for any injury, loss, or damage to personal property.</p>
						<p class="text-slate-300">Campers are responsible for their own safety and belongings.</p>
					</li>
				</ol>
			</div>
			<div class="rounded-2xl border border-fuchsia-500/40 bg-fuchsia-500/5 p-6 text-sm text-slate-200">
				<p class="font-semibold text-white">For Questions or Assistance:</p>
				<p class="mt-2 text-slate-200">üìû Contact Lola at <a href="tel:13608805545" class="font-semibold text-fuchsia-200 underline underline-offset-4 transition hover:text-fuchsia-100">(360) 880-5545</a></p>
			</div>
		</div>
	</dialog>

	<script
		id="runtime-events-config"
		type="application/json"
		is:inline
	>
		{JSON.stringify({ endpoint: '/api/events', timezone: festivalTimeZone })}
	</script>
	<script type="module" src={runtimeEventsScriptUrl}></script>
	<script type="module" src={eventModalScriptUrl}></script>
	<script type="module" src={pageViewCounterScriptUrl}></script>

</BaseLayout>
